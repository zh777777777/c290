<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    h1, h2, h3, h4 {
      font-family: 'DM Sans', sans-serif;
    }
  .order-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.2s;
  }
  
  .order-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
  
  .stall-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
  }
  
  .stall-info h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
  }
  
  .stall-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: #6b7280;
  }
  
  .queue-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    background: #dbeafe;
    color: #1e40af;
    border-radius: 12px;
    font-weight: 500;
    font-size: 0.875rem;
  }
  
  .queue-badge.busy {
    background: #fee2e2;
    color: #991b1b;
  }
  
  .order-form {
    display: none;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
  }
  
  .order-form.active {
    display: block;
  }
  
  .form-group {
    margin-bottom: 1rem;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #374151;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
  }
  
  .form-group textarea {
    resize: vertical;
    min-height: 80px;
  }
  
  .delivery-summary {
    background: #f9fafb;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
  }
  
  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }
  
  .summary-row.total {
    font-weight: 600;
    font-size: 1rem;
    padding-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
    margin-top: 0.5rem;
  }
  
  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .btn-primary {
    background: #2563eb;
    color: white;
  }
  
  .btn-primary:hover {
    background: #1d4ed8;
  }
  
  .btn-secondary {
    background: #10b981;
    color: white;
  }
  
  .btn-secondary:hover {
    background: #059669;
  }
  
  .btn-cancel {
    background: #6b7280;
    color: white;
    margin-right: 0.5rem;
  }
  
  .btn-cancel:hover {
    background: #4b5563;
  }
  
  .location-display {
    background: #fef3c7;
    border: 1px solid #fbbf24;
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .peak-hour-notice {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 0.75rem;
    margin-bottom: 1rem;
    border-radius: 4px;
  }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Navigation -->
  <%- include('partials/nav') %>

<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
  <h1 style="margin-bottom: 0.5rem;">Order Food with Delivery</h1>
  <p style="color: #6b7280; margin-bottom: 2rem;">Select a stall and place your order. Student delivery available!</p>
  
  <% if (user && user.currentBlockId) { %>
    <div class="location-display">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
      </svg>
      <span><strong>Your Location:</strong> <%= currentBlock ? currentBlock.name : 'Not set' %></span>
      <a href="/recommendations" style="margin-left: auto; color: #2563eb;">Change</a>
    </div>
  <% } else { %>
    <div class="location-display" style="background: #fee2e2; border-color: #ef4444;">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
      </svg>
      <span><strong>Please set your location first</strong></span>
      <a href="/recommendations" style="margin-left: auto; color: #dc2626; font-weight: 500;">Set Location</a>
    </div>
  <% } %>
  
  <% if (isPeakHour) { %>
    <div class="peak-hour-notice">
      <strong>‚ö° Peak Hour (11:30 AM - 1:30 PM, 5:30 PM - 7:30 PM)</strong><br>
      Delivery fee increased by $0.50 during peak hours
    </div>
  <% } %>
  
  <div class="stalls-grid">
    <% stalls.forEach(stall => { 
      const canteen = canteens.find(c => c.id === stall.canteenId);
      const isBusy = stall.currentQueue > 15;
    %>
      <div class="order-card" data-stall-id="<%= stall.id %>">
        <div class="stall-header">
          <div class="stall-info">
            <h3 data-testid="text-stall-name-<%= stall.id %>"><%= stall.name %></h3>
            <div class="stall-meta">
              <span>üìç <%= canteen ? canteen.name : 'Unknown' %></span>
              <span>üçΩÔ∏è <%= stall.cuisineType %></span>
              <span>‚≠ê <%= parseFloat(stall.rating || 0).toFixed(1) %></span>
            </div>
          </div>
          <span class="queue-badge <%= isBusy ? 'busy' : '' %>" data-testid="badge-queue-<%= stall.id %>">
            <%= stall.currentQueue %> in queue
          </span>
        </div>
        
        <button 
          class="btn btn-primary" 
          onclick="toggleOrderForm('<%= stall.id %>')"
          data-testid="button-order-<%= stall.id %>"
          <%= !user || !user.currentBlockId ? 'disabled' : '' %>
        >
          Order Now
        </button>
        
        <div class="order-form" id="order-form-<%= stall.id %>">
          <form onsubmit="submitOrder(event, '<%= stall.id %>', '<%= canteen ? canteen.name : '' %>')">
            <div class="form-group">
              <label for="items-<%= stall.id %>">Food Items <span style="color: #ef4444;">*</span></label>
              <textarea 
                id="items-<%= stall.id %>" 
                name="items" 
                placeholder="e.g., Chicken Rice, Ice Lemon Tea"
                required
                data-testid="input-food-items-<%= stall.id %>"
              ></textarea>
              <small style="color: #6b7280;">List all items you want to order</small>
            </div>
            
            <div class="form-group">
              <label for="amount-<%= stall.id %>">Food Total ($) <span style="color: #ef4444;">*</span></label>
              <input 
                type="number" 
                id="amount-<%= stall.id %>" 
                name="amount" 
                step="0.01" 
                min="1"
                placeholder="8.50"
                required
                oninput="updateDeliverySummary('<%= stall.id %>')"
                data-testid="input-total-amount-<%= stall.id %>"
              />
            </div>
            
            <div class="form-group">
              <label for="delivery-location-<%= stall.id %>">Delivery Location <span style="color: #ef4444;">*</span></label>
              <select 
                id="delivery-location-<%= stall.id %>" 
                name="deliveryLocation" 
                required
                data-testid="select-delivery-location-<%= stall.id %>"
              >
                <option value="">Select delivery location</option>
                <% campusBlocks.forEach(block => { %>
                  <option value="<%= block.id %>" <%= user && user.currentBlockId === block.id ? 'selected' : '' %>>
                    <%= block.name %> (<%= block.shortName %>)
                  </option>
                <% }); %>
              </select>
            </div>
            
            <div class="delivery-summary" id="summary-<%= stall.id %>">
              <div class="summary-row">
                <span>Food Total:</span>
                <span id="food-total-<%= stall.id %>">$0.00</span>
              </div>
              <div class="summary-row">
                <span>Delivery Fee <%= isPeakHour ? '(Peak Hour)' : '' %>:</span>
                <span id="delivery-fee-<%= stall.id %>">$<%= isPeakHour ? '2.00' : '1.50' %></span>
              </div>
              <div class="summary-row total">
                <span>Total Amount:</span>
                <span id="total-amount-<%= stall.id %>">$0.00</span>
              </div>
            </div>
            
            <div style="margin-top: 1rem;">
              <button type="button" class="btn btn-cancel" onclick="toggleOrderForm('<%= stall.id %>')">
                Cancel
              </button>
              <button 
                type="submit" 
                class="btn btn-secondary"
                data-testid="button-submit-order-<%= stall.id %>"
              >
                Place Order with Delivery
              </button>
            </div>
          </form>
        </div>
      </div>
    <% }); %>
  </div>
</div>

<script>
  const isPeakHour = <%= isPeakHour %>;
  const deliveryFee = isPeakHour ? 2.00 : 1.50;
  
  function toggleOrderForm(stallId) {
    const form = document.getElementById(`order-form-${stallId}`);
    form.classList.toggle('active');
  }
  
  function updateDeliverySummary(stallId) {
    const amountInput = document.getElementById(`amount-${stallId}`);
    const foodTotal = parseFloat(amountInput.value) || 0;
    const total = foodTotal + deliveryFee;
    
    document.getElementById(`food-total-${stallId}`).textContent = `$${foodTotal.toFixed(2)}`;
    document.getElementById(`total-amount-${stallId}`).textContent = `$${total.toFixed(2)}`;
  }
  
  async function submitOrder(event, stallId, canteenName) {
    event.preventDefault();
    
    const form = event.target;
    const foodItems = form.items.value.trim();
    const totalAmount = parseFloat(form.amount.value);
    const deliveryBlockId = form.deliveryLocation.value;
    
    if (!foodItems || !totalAmount || !deliveryBlockId) {
      alert('Please fill in all required fields');
      return;
    }
    
    const deliveryLocationText = form.deliveryLocation.options[form.deliveryLocation.selectedIndex].text;
    
    try {
      const response = await fetch('/api/delivery-requests', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          stallId,
          foodItems,
          totalAmount: totalAmount.toFixed(2),
          deliveryFee: deliveryFee.toFixed(2),
          isPeakHour,
          pickupLocation: canteenName,
          deliveryLocation: deliveryLocationText,
          deliveryBlockId
        })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to place order');
      }
      
      const order = await response.json();
      
      // Show success message
      alert(`Order placed successfully! Order ID: ${order.id}\n\nA student delivery person will pick up your order soon. You can track your order status in My Orders.`);
      
      // Reset form
      form.reset();
      toggleOrderForm(stallId);
      
      // Optionally redirect to order tracking page
      // window.location.href = '/my-orders';
      
    } catch (error) {
      console.error('Order error:', error);
      alert(`Failed to place order: ${error.message}`);
    }
  }
</script>
</body>
</html>
