<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#2D8659',
              50: '#E8F5EF',
              100: '#D1EBE0',
              500: '#2D8659',
              600: '#256F4A',
              700: '#1D583B',
            },
            accent: {
              DEFAULT: '#F59E0B',
              100: '#FEF3C7',
              500: '#F59E0B',
            },
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui'],
            display: ['DM Sans', 'ui-sans-serif', 'system-ui'],
          },
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: 'DM Sans', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <%- include('partials/nav', { activePage: 'admin' }) %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 font-display">Admin Dashboard</h1>
    <p class="text-gray-600 mt-2">Manage platform data and monitor system metrics</p>
  </div>

  <!-- Platform Statistics -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-primary-100 text-primary-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-gray-500 text-sm">Canteens</p>
          <p class="text-2xl font-bold text-gray-900" data-testid="stat-canteens"><%= stats.totalCanteens %></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-accent-100 text-accent-500">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-gray-500 text-sm">Stalls</p>
          <p class="text-2xl font-bold text-gray-900" data-testid="stat-stalls"><%= stats.totalStalls %></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-green-100 text-green-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-gray-500 text-sm">Vendors</p>
          <p class="text-2xl font-bold text-gray-900" data-testid="stat-vendors"><%= stats.totalVendors %></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-gray-500 text-sm">Active Listings</p>
          <p class="text-2xl font-bold text-gray-900" data-testid="stat-active-listings"><%= stats.activeListings %></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-gray-500 text-sm">Total Ratings</p>
          <p class="text-2xl font-bold text-gray-900" data-testid="stat-ratings"><%= stats.totalRatings %></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Management Tabs -->
  <div class="bg-white rounded-lg shadow-md border border-gray-200">
    <div class="border-b border-gray-200">
      <nav class="flex -mb-px">
        <button onclick="showTab('canteens')" id="tab-canteens" class="px-6 py-4 text-sm font-medium border-b-2 border-primary-600 text-primary-600" data-testid="tab-canteens">
          Canteens
        </button>
        <button onclick="showTab('stalls')" id="tab-stalls" class="px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-testid="tab-stalls">
          Stalls
        </button>
        <button onclick="showTab('vendors')" id="tab-vendors" class="px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-testid="tab-vendors">
          Vendors
        </button>
        <button onclick="showTab('listings')" id="tab-listings" class="px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-testid="tab-listings">
          Food Listings
        </button>
      </nav>
    </div>

    <!-- Canteens Tab -->
    <div id="content-canteens" class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-900">Manage Canteens</h2>
        <button onclick="showAddCanteenForm()" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700" data-testid="button-add-canteen">
          Add Canteen
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Stalls</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% canteens.forEach(canteen => { %>
              <tr data-testid="row-canteen-<%= canteen.id %>">
                <td class="px-6 py-4 text-sm text-gray-900"><%= canteen.name %></td>
                <td class="px-6 py-4 text-sm text-gray-500"><%= canteen.location %></td>
                <td class="px-6 py-4 text-sm text-gray-500"><%= canteen.totalStalls %></td>
                <td class="px-6 py-4 text-sm">
                  <button onclick="deleteCanteen('<%= canteen.id %>')" class="text-red-600 hover:text-red-900" data-testid="button-delete-canteen-<%= canteen.id %>">
                    Delete
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Stalls Tab -->
    <div id="content-stalls" class="p-6 hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-900">Manage Stalls</h2>
        <button onclick="showAddStallForm()" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700" data-testid="button-add-stall">
          Add Stall
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Canteen</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cuisine</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Queue</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% stalls.forEach(stall => { %>
              <tr data-testid="row-stall-<%= stall.id %>">
                <td class="px-6 py-4 text-sm text-gray-900"><%= stall.name %></td>
                <td class="px-6 py-4 text-sm text-gray-500">
                  <%= canteens.find(c => c.id === stall.canteenId)?.name || 'N/A' %>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500"><%= stall.cuisineType %></td>
                <td class="px-6 py-4 text-sm text-gray-500"><%= stall.currentQueue %> people</td>
                <td class="px-6 py-4 text-sm text-gray-500">
                  <%= parseFloat(stall.rating).toFixed(1) %> (<%= stall.reviewCount %>)
                </td>
                <td class="px-6 py-4 text-sm">
                  <button onclick="deleteStall('<%= stall.id %>')" class="text-red-600 hover:text-red-900" data-testid="button-delete-stall-<%= stall.id %>">
                    Delete
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Vendors Tab -->
    <div id="content-vendors" class="p-6 hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-900">Manage Vendors</h2>
        <button onclick="showAddVendorForm()" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700" data-testid="button-add-vendor">
          Add Vendor
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Address</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% vendors.forEach(vendor => { %>
              <tr data-testid="row-vendor-<%= vendor.id %>">
                <td class="px-6 py-4 text-sm text-gray-900"><%= vendor.name %></td>
                <td class="px-6 py-4 text-sm text-gray-500 capitalize"><%= vendor.type %></td>
                <td class="px-6 py-4 text-sm text-gray-500"><%= vendor.address %></td>
                <td class="px-6 py-4 text-sm text-gray-500">
                  <%= parseFloat(vendor.rating).toFixed(1) %> (<%= vendor.reviewCount %>)
                </td>
                <td class="px-6 py-4 text-sm">
                  <button onclick="deleteVendor('<%= vendor.id %>')" class="text-red-600 hover:text-red-900" data-testid="button-delete-vendor-<%= vendor.id %>">
                    Delete
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Food Listings Tab -->
    <div id="content-listings" class="p-6 hidden">
      <h2 class="text-xl font-bold text-gray-900 mb-6">Manage Food Listings</h2>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% listings.forEach(listing => { %>
              <tr data-testid="row-listing-<%= listing.id %>">
                <td class="px-6 py-4 text-sm text-gray-900"><%= listing.title %></td>
                <td class="px-6 py-4 text-sm text-gray-500">
                  <%= vendors.find(v => v.id === listing.vendorId)?.name || 'N/A' %>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">
                  $<%= parseFloat(listing.discountedPrice).toFixed(2) %>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500"><%= listing.quantity %></td>
                <td class="px-6 py-4 text-sm">
                  <% if (listing.available) { %>
                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Available</span>
                  <% } else { %>
                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">Unavailable</span>
                  <% } %>
                </td>
                <td class="px-6 py-4 text-sm space-x-2">
                  <button onclick="toggleListingAvailability('<%= listing.id %>', <%= !listing.available %>)" 
                    class="text-blue-600 hover:text-blue-900" 
                    data-testid="button-toggle-listing-<%= listing.id %>">
                    <%= listing.available ? 'Hide' : 'Show' %>
                  </button>
                  <button onclick="deleteListing('<%= listing.id %>')" class="text-red-600 hover:text-red-900" data-testid="button-delete-listing-<%= listing.id %>">
                    Delete
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  function showTab(tabName) {
    // Hide all content
    ['canteens', 'stalls', 'vendors', 'listings'].forEach(tab => {
      document.getElementById('content-' + tab).classList.add('hidden');
      document.getElementById('tab-' + tab).classList.remove('border-primary-600', 'text-primary-600');
      document.getElementById('tab-' + tab).classList.add('border-transparent', 'text-gray-500');
    });

    // Show selected content
    document.getElementById('content-' + tabName).classList.remove('hidden');
    document.getElementById('tab-' + tabName).classList.add('border-primary-600', 'text-primary-600');
    document.getElementById('tab-' + tabName).classList.remove('border-transparent', 'text-gray-500');
  }

  function showAddCanteenForm() {
    const name = prompt('Enter canteen name:');
    const location = prompt('Enter canteen location:');
    if (name && location) {
      fetch('/api/canteens', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, location })
      }).then(() => location.reload());
    }
  }

  function deleteCanteen(id) {
    if (confirm('Are you sure you want to delete this canteen? This will also delete all its stalls.')) {
      fetch(`/api/canteens/${id}`, { method: 'DELETE' })
        .then(() => location.reload());
    }
  }

  function showAddStallForm() {
    const name = prompt('Enter stall name:');
    const canteenId = prompt('Enter canteen ID (e.g., canteen-1):');
    const cuisineType = prompt('Enter cuisine type:');
    if (name && canteenId && cuisineType) {
      fetch('/api/stalls', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          name, 
          canteenId, 
          cuisineType,
          currentQueue: 0,
          estimatedWaitTime: 0
        })
      }).then(() => location.reload());
    }
  }

  function deleteStall(id) {
    if (confirm('Are you sure you want to delete this stall?')) {
      fetch(`/api/stalls/${id}`, { method: 'DELETE' })
        .then(() => location.reload());
    }
  }

  function showAddVendorForm() {
    const name = prompt('Enter vendor name:');
    const type = prompt('Enter vendor type (bakery, restaurant, cafe, hawker):');
    const address = prompt('Enter vendor address:');
    const operatingHours = prompt('Enter operating hours (e.g., 8:00 AM - 6:00 PM):');
    if (name && type && address && operatingHours) {
      fetch('/api/vendors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, type, address, operatingHours })
      }).then(() => location.reload());
    }
  }

  function deleteVendor(id) {
    if (confirm('Are you sure you want to delete this vendor? This will also delete all their food listings.')) {
      fetch(`/api/vendors/${id}`, { method: 'DELETE' })
        .then(() => location.reload());
    }
  }

  function toggleListingAvailability(id, available) {
    fetch(`/api/food-listings/${id}/availability`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ available })
    }).then(() => location.reload());
  }

  function deleteListing(id) {
    if (confirm('Are you sure you want to delete this food listing?')) {
      fetch(`/api/food-listings/${id}`, { method: 'DELETE' })
        .then(() => location.reload());
    }
  }
</script>

</body>
</html>
